import json
import requests
import os

def get_tables_from_manifest(manifest_path):
    """
    returns a csv of tables from a manifest file. We filter out
    """
    table_csv_str = "schema, table, materialized, created_at, partition_by\n"
    with open(manifest_path, "r") as f:
        print(f"Loading manifest file at {manifest_path} ...")
        manifest = json.load(f)
    for node_name in manifest["nodes"]:
        node_data = manifest["nodes"][node_name]
        
        if node_data["resource_type"] == "model":
            schema = node_data["schema"]
            table = node_data["alias"]
            if 'dunesql' in node_data["tags"]:
                print(node_data["original_file_path"])
            # row = f"{schema}, {table}, {materialized}, {created_at}, {partition_by}\n"
            # table_csv_str += row

    return table_csv_str

def upload_csv(table_csv, target):
    """
    Upload CSV string to dune.

    target = name of table to upload csv to
    """

    print(f"Writing {target} to Dune.com ...")
    url = 'https://api.dev.dune.com/api/v1/table/upload/csv'
    api_key = os.environ.get('DUNE_API_KEY')
    if not api_key:
        raise Exception('DUNE_API_KEY environment variable not set!')
    headers = {'X-Dune-Api-Key': api_key}
    payload = {
        "table_name": target,
        "description": "Tables generated by Spark Spellbook.",
        "data": table_csv
    }
    response = requests.post(url, data=json.dumps(payload), headers=headers)
    if response.status_code == 200 and response.json()['success']:
        print(f'Success writing CSV to delta_dev.dune_upload.{target} ', flush=True)
    else:
        print('Error writing CSV to Dune.com!')
        raise Exception(response.content)
    
if __name__ == "__main__":
    get_tables_from_manifest("target/manifest.json")