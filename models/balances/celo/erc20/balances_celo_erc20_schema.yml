version: 2

models:
  - name: balances_celo_erc20_hour
    meta:
      blockchain: celo
      sector: balances
      project: erc20
      contributors: soispoke, dot2dotseurat, tomfutago
    config:
      tags: ['balances', 'celo', 'erc20', 'hour', 'soispoke', 'dot2dotseurat', 'tomfutago']
    description: >
        Hourly token balances of ERC20 Celo tokens per wallet and contract address pair.
        Depends on transfers_celo_erc20
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - block_hour
            - wallet_address
            - token_address
    columns:
      - &blockchain
        name: blockchain
        description: "Blockchain"
      - &block_month
        name: block_month
        description: "Block Month column used to partition data in this table"
        tests:
          - not_null
      - &block_hour
        name: block_hour
        description: "UTC event block time truncated to the hour mark"
      - &wallet_address
        name: wallet_address
        description: "Address of the wallet holding this ERC20 token"
      - &token_address
        name: token_address
        description: "Contract address for the ERC20 token"
      - &symbol
        name: symbol
        description: "Token symbol"
      - &amount_raw
        name: amount_raw
        description: "Raw amount of ERC20 token held *before* taking into account token decimals"
      - &amount
        name: amount
        description: "Raw amount of ERC20 token held *after* taking into account token decimals"
      - &amount_usd
        name: amount_usd
        description: "Amount of ERC20 token held in USD if we have it"
      - &recency_index
        name: recency_index
        description: "Index of most recent balance ascending. recency_index=1 is the wallet/contract pair's most recent balance"

  - name: balances_celo_erc20_hour_helper
    meta:
      blockchain: celo
      sector: balances
      project: erc20
      contributors: tomfutago
    config:
      tags: ['balances', 'celo', 'erc20', 'hour', 'helper', 'tomfutago']
    description: >
        Helper table with hourly history filled for ERC20 Celo tokens per wallet and contract address pair.
        Added to aid in incremental build performance. Depends on transfers_celo_erc20_rolling_hour.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - block_hour
            - wallet_address
            - token_address
    columns:
      - *wallet_address
      - *token_address
      - *block_month
      - *block_hour

  - name: balances_celo_erc20_day
    meta:
      blockchain: celo
      sector: balances
      project: erc20
      contributors: soispoke, dot2dotseurat, tomfutago
    config:
      tags: ['balances', 'celo', 'erc20', 'day', 'soispoke', 'dot2dotseurat', 'tomfutago']
    description: >
        Daily token balances of ERC20 Celo tokens per wallet and contract address pair.
        Depends on transfers_celo_erc20.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - block_day
            - wallet_address
            - token_address
    columns:
      - *blockchain
      - *block_month
      - &block_day
        name: block_day
        description: "UTC event block time truncated to the day mark"
      - *wallet_address
      - *token_address
      - *symbol
      - *amount_raw
      - *amount
      - *amount_usd
      - *recency_index

  - name: balances_celo_erc20_latest
    meta:
      blockchain: celo
      sector: balances
      project: erc20
      contributors: soispoke, dot2dotseurat, tomfutago
    config:
      tags: ['balances', 'celo', 'erc20', 'latest', 'soispoke', 'dot2dotseurat', 'tomfutago']
    description: >
        Latest token balances of ERC20 Celo tokens per wallet and contract address pair.
        Depends on transfers_celo_erc20.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - wallet_address
            - token_address
    columns:
      - *blockchain
      - *wallet_address
      - *token_address
      - *symbol
      - *amount_raw
      - *amount
      - *amount_usd
      - &last_updated
        name: last_updated
        description: "UTC timestamp when data was last updated"

  - name: balances_celo_erc20_noncompliant
    meta:
      blockchain: celo
      sector: balances
      project: erc20
      contributors: dot2dotseurat, tomfutago
    config:
      tags: ['view', 'erc20', 'erc20_latest', 'erc20_hourly', 'erc20_daily']
    description: >
        Helper model. This queries all of the token address with negative balances. 
        Some wiggle room is allowed for tokens with very small negative balances which
        could have been introduced by interger overflow due to very large ints. 
        It's likely that the token contract is non-compliant if a negative balance occurs. 
        Therefore, we use this table to remove those contracts from our token balances tables.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - token_address
    columns:
      - name: token_address
        description: "Token Address for possibly non-compliant erc20 token"
