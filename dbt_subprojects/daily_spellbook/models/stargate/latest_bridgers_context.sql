{{ config(
    alias='latest_bridgers_context',
    materialized='incremental',
    unique_key='bridge_tx_hash',
    schema='bridge_user_tracking'
) }}

with assets (token, decimals, chain,  endpointID, pool, contract) as (values 

('ETH', 18, 'ethereum', 30101, 0x77b2043768d28E9C9aB44E1aBfC95944bcE57931, 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2),
('USDC', 6, 'ethereum', 30101, 0xc026395860Db2d07ee33e05fE50ed7bD583189C7, 0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48),
('USDT', 6, 'ethereum', 30101, 0x933597a323Eb81cAe705C5bC29985172fd5A3973, 0xdAC17F958D2ee523a2206206994597C13D831ec7),
('mETH', 18, 'ethereum', 30101,  0x268Ca24DAefF1FaC2ed883c598200CcbB79E931D ,  0xd5f7838f5c461feff7fe49ea5ebaf7728bb0adfa ),
--METIS', 18, 'ethereum', 30101, 0xcDafB1b2dB43f366E48e6F614b8DCCBFeeFEEcD3,  0x9e32b13ce7f2e80a01932b42553652e053d6ed8e ),

('USDC', 18, 'bnb', 30102,  0x962Bd449E630b0d928f308Ce63f1A21F02576057 ,  0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d ),
('USDT', 18, 'bnb', 30102,  0x138EB30f73BC423c6455C53df6D89CB01d9eBc63 ,  0x55d398326f99059fF775485246999027B3197955 ),

('USDC', 6, 'avalanche_c', 30106,  0x5634c4a5FEd09819E3c46D86A965Dd9447d86e47 ,  0xb97ef9ef8734c71904d8002f8b6bc66dd9c48a6e ),
('USDT', 6, 'avalanche_c', 30106,  0x12dC9256Acc9895B076f6638D628382881e62CeE ,  0x9702230a8ea53601f5cd2dc00fdbc13d4df4a8c7 ),

('USDC', 6, 'polygon', 30109,  0x9Aa02D4Fae7F58b8E8f34c66E756cC734DAc7fe4 ,  0x3c499c542cef5e3811e1192ce70d8cc03d5c3359 ),
('USDT', 6, 'polygon', 30109,  0xd47b03ee6d86Cf251ee7860FB2ACf9f91B9fD4d7 ,  0xc2132d05d31c914a87c6611c10748aeb04b58e8f ),

('ETH', 18, 'arbitrum', 30110,  0xA45B5130f36CDcA45667738e2a258AB09f4A5f7F , 0x82aF49447D8a07e3bd95BD0d56f35241523fBab1),
('USDC', 6, 'arbitrum', 30110,  0xe8CDF27AcD73a434D661C84887215F7598e7d0d3 ,  0xaf88d065e77c8cc2239327c5edb3a432268e5831 ),
('USDT', 6, 'arbitrum', 30110,  0xcE8CcA271Ebc0533920C83d39F417ED6A0abB7D0 ,  0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9 ),

('ETH', 18, 'optimism', 30111,  0xe8CDF27AcD73a434D661C84887215F7598e7d0d3 , 0x4200000000000000000000000000000000000006),
('USDC', 6, 'optimism', 30111,  0xcE8CcA271Ebc0533920C83d39F417ED6A0abB7D0 ,  0x0b2c639c533813f4aa9d7837caf62653d097ff85 ),
('USDT', 6, 'optimism', 30111,  0x19cFCE47eD54a88614648DC3f19A5980097007dD ,  0x94b008aa00579c1307b0ef2c499ad98a8ce58e58 ),

('WETH', 18, 'Metis', 30151,  0x36ed193dc7160D3858EC250e69D12B03Ca087D08 ,  0x420000000000000000000000000000000000000a ),
--('METIS', 18, 'Metis', 30151,  0x36ed193dc7160D3858EC250e69D12B03Ca087D08 ,  0xdeaddeaddeaddeaddeaddeaddeaddeaddead0000 ),
('m.USDT', 6, 'Metis', 30151,  0x4dCBFC0249e8d5032F89D6461218a9D2eFff5125 ,  0xbb06dca3ae6887fabf931640f67cab3e3a16f4dc ),

('ETH', 18, 'linea', 30183,  0x81F6138153d473E8c5EcebD3DC8Cd4903506B075 , 0xe5D7C2a44FfDDf6b295A15c148167daaAf5Cf34f),

('USDC', 6, 'mantle', 30181,  0xAc290Ad4e0c891FDc295ca4F0a6214cf6dC6acDC ,  0x09bc4e0d864854c6afb6eb9a9cdf58ac190d0df9 ),
('USDT', 6, 'mantle', 30181,  0xB715B85682B731dB9D5063187C450095c91C57FC ,  0x201eba5cc46d216ce6dc03f6a759e8e766e956ae ),
('WETH', 18, 'mantle', 30181,  0x4c1d3Fc3fC3c177c3b633427c2F769276c547463 ,  0xdeaddeaddeaddeaddeaddeaddeaddeaddead1111 ),
('mETH', 18, 'mantle', 30181,  0xF7628d84a2BbD9bb9c8e686AC95BB5d55169F3F1 ,  0xcda86a272531e8640cd7f1a92c01839911b90bb0 ),

('ETH', 18, 'base', 30184,  0xdc181Bd607330aeeBEF6ea62e03e5e1Fb4B6F7C7 , 0x4200000000000000000000000000000000000006),
('USDC', 6, 'base', 30184,  0x27a16dc786820B16E5c9028b75B99F6f604b5d26 ,  0x833589fcd6edb6e08f4c7c32d4f71b54bda02913 ),

('USDT', 6, 'kava', 30177,  0x41A5b0470D96656Fb3e8f68A218b39AdBca3420b ,  0x919c1c267bc06a7039e03fcc2ef738525769109c ),

('USDC.e', 6, 'scroll', 30214,  0x3Fc69CC4A842838bCDC9499178740226062b14E4 ,  0x06efdbff2a14a7c8e15944d1f4a48f9f95f663a4 ),
('ETH', 18, 'scroll', 30214,  0xC2b638Cb5042c1B3c5d5C969361fB50569840583 , 0x5300000000000000000000000000000000000004),

('USDC', 6, 'aurora', 30211,  0x81F6138153d473E8c5EcebD3DC8Cd4903506B075 ,  0x368ebb46aca6b8d0787c96b2b20bd3cc3f2c45f7 ),

('USDC', 6, 'core', 30153,  0x2F6F07CDcf3588944Bf4C42aC74ff24bF56e7590 ,  0xa4151b2b3e269645181dccf2d426ce75fcbdeca9 ),
('USDT', 6, 'core', 30153,  0x45f1A95A4D3f3836523F5c83673c797f4d4d263B ,  0x900101d06a7426441ae63e9ab3b9b0f63be145f1 ),

('USDC', 6, 'sonic', 30332,  0xA272fFe20cFfe769CdFc4b63088DCD2C82a2D8F9 ,  0x29219dd400f2bf60e5a23d13be72b486d4038894 ),

('ETH', 18, 'unichain', 30320,  0xe9aBA835f813ca05E50A6C0ce65D0D74390F7dE7 ,  0x4200000000000000000000000000000000000006 ),

('WETH', 18, 'gnosis', 30145,  0xe9aBA835f813ca05E50A6C0ce65D0D74390F7dE7 ,  0x6a023ccd1ff6f2045c3309768ead9e68f978f6e1 ),
('USDC', 6, 'gnosis', 30145,  0xB1EeAD6959cb5bB9B20417d6689922523B2B86C3 ,  0x2a22f9c3b484c3629090feed35f17ff8f88f76f0 ),

('ETH', 18, 'soneium', 30340,  0x2F6F07CDcf3588944Bf4C42aC74ff24bF56e7590 , 0x4200000000000000000000000000000000000006),
('USDC', 6, 'soneium', 30340,  0x45f1A95A4D3f3836523F5c83673c797f4d4d263B ,  0xbA9986D2381edf1DA03B0B9c1f8b00dc4AacC369 ),

--Hydra CAs

('USDC', 6, 'kaia', 30150, 0x01A7c805cc47AbDB254CD8AaD29dE5e447F59224, 0xe2053bcf56d2030d2470fb454574237cf9ee3d4b),
('USDT', 6, 'kaia' ,30150 , 0x8619bA1B324e099CB2227060c4BC5bDEe14456c6, 0x9025095263d1e548dc890a7589a4c78038ac40ab),
('WETH', 18,'kaia' ,30150 , 0xBB4957E44401a31ED81Cab33539d9e8993FA13Ce, 0x55acee547df909cf844e32dd66ee55a6f81dc71b), 

('USDC', 6, 'iota',30284 , 0x8e8539e4CcD69123c623a106773F2b0cbbc58746, 0xFbDa5F676cB37624f28265A144A48B0d6e87d3b6),
('USDT',6, 'iota', 30284, 0x77C71633C34C3784ede189d74223122422492a0f, 0xC1B8045A6ef2934Cf0f78B0dbD489969Fa9Be7E4),
('WETH', 18, 'iota',30284 , 0x9c2dc7377717603eB92b2655c5f2E7997a4945BD, 0x160345fC359604fC6e70E3c5fAcbdE5F7A9342d8),

('USDC', 6, 'taiko', 30290, 0x77C71633C34C3784ede189d74223122422492a0f, 0x19e26B0638bf63aa9fa4d14c6baF8D52eBE86C5C),
('USDT', 6, 'taiko', 30290, 0x1C10CC06DC6D35970d1D53B2A23c76ef370d4135, 0x9c2dc7377717603eB92b2655c5f2E7997a4945BD),

('USDC', 6, 'rari' ,30235 , 0x875bee36739e7Ce6b60E056451c556a88c59b086, 0xFbDa5F676cB37624f28265A144A48B0d6e87d3b6),
('USDT', 6, 'rari',30235 , 0x17d65bF79E77B6Ab21d8a0afed3bC8657d8Ee0B2, 0x362FAE9A75B27BBc550aAc28a7c1F96C8D483120),

('USDC', 6, 'sei', 30280,  0x45d417612e177672958dC0537C45a8f8d754Ac2E ,  0x3894085Ef7Ff0f0aeDf52E2A2704928d1Ec074F1 ),
('USDT', 6, 'sei', 30280,  0x0dB9afb4C33be43a0a0e396Fd1383B4ea97aB10a ,  0x0dB9afb4C33be43a0a0e396Fd1383B4ea97aB10a ),
('WETH', 18, 'sei', 30280,  0x5c386D85b1B82FD9Db681b9176C8a4248bb6345B ,  0x160345fC359604fC6e70E3c5fAcbdE5F7A9342d8 ),

('USDC', 6, 'flare', 30295,  0x77C71633C34C3784ede189d74223122422492a0f ,  0xFbDa5F676cB37624f28265A144A48B0d6e87d3b6 ),
('USDT', 6, 'flare', 30295,  0x1C10CC06DC6D35970d1D53B2A23c76ef370d4135 ,  0x0B38e83B86d491735fEaa0a791F65c2B99535396 ),
('WETH', 18, 'flare', 30295,  0x8e8539e4CcD69123c623a106773F2b0cbbc58746 ,  0x1502FA4be69d526124D453619276FacCab275d3D ),

('USDC', 6, 'gravity', 30294,  0xC1B8045A6ef2934Cf0f78B0dbD489969Fa9Be7E4, 0xFbDa5F676cB37624f28265A144A48B0d6e87d3b6 ), 
('USDT', 6, 'gravity', 30294,  0x0B38e83B86d491735fEaa0a791F65c2B99535396, 0x816E810f9F787d669FB71932DeabF6c83781Cd48 ), 
('WETH', 6, 'gravity', 30294,  0x17d65bF79E77B6Ab21d8a0afed3bC8657d8Ee0B2, 0xf6f832466Cd6C21967E0D954109403f36Bc8ceaA ), 


('ETH', 18, 'lightlink', 30309,  0x8731d54E9D02c286767d56ac03e8037C07e01e98 , 0x7EbeF2A4b1B09381Ec5B9dF8C5c6f2dBECA59c73),
('USDC', 6, 'lightlink', 30309,  0x8EE21165Ecb7562BA716c9549C1dE751282b9B33 ,  0xbCF8C1B03bBDDA88D579330BDF236B58F8bb2cFd ),
('USDT', 6, 'lightlink', 30309,  0x06D538690AF257Da524f25D0CD52fD85b1c2173E ,  0x808d7c71ad2ba3FA531b068a2417C63106BC0949 ),

('USDC', 6, 'abstract', 30324,  0x91a5Fe991ccB876d22847967CEd24dCd7A426e0E ,  0x84A71ccD554Cc1b02749b35d22F684CC8ec987e1 ),
('USDT', 6, 'abstract', 30324,  0x943C484278b8bE05D119DfC73CfAa4c9D8f11A76 ,  0x0709f39376deee2a2dfc94a58edeb2eb9df012bd ),
('WETH', 18, 'abstract', 30324,  0x221F0E1280Ec657503ca55c708105F1e1529527D ,  0x3439153eb7af838ad19d56e1571fbd09333c2809 ),


('USDC', 6, 'peaq', 30302,  0x5c1a97C144A97E9b370F833a06c70Ca8F2f30DE5 ,  0xbbA60da06c2c5424f03f7434542280FCAd453d10 ),
('USDT', 6, 'peaq', 30302,  0x07cd5A2702394E512aaaE54f7a250ea0576E5E8C ,  0xf4D9235269a96aaDaFc9aDAe454a0618eBE37949 ),
('WETH', 18, 'peaq', 30302,  0xe7Ec689f432f29383f217e36e680B5C855051f25 ,  0x6694340fc020c5E6B96567843da2df01b2CE1eb6 ),

('USDC', 6, 'flow', 30336,  0xAF54BE5B6eEc24d6BFACf1cce4eaF680A8239398 ,  0xF1815bd50389c46847f0Bda824eC8da914045D14 ),
('USDT', 6, 'flow', 30336,  0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6 ,  0x674843C06FF83502ddb4D37c2E09C01cdA38cbc8 ),
('WETH', 18, 'flow', 30336,  0x45f1A95A4D3f3836523F5c83673c797f4d4d263B ,  0x2F6F07CDcf3588944Bf4C42aC74ff24bF56e7590 ),

('USDC', 6, 'goat', 30361,  0xbbA60da06c2c5424f03f7434542280FCAd453d10 ,  0x3022b87ac063DE95b1570F46f5e470F8B53112D8 ),
('USDT', 6, 'goat', 30361,  0x549943e04f40284185054145c6E4e9568C1D3241 ,  0xE1AD845D93853fff44990aE0DcecD8575293681e ),
('USDT', 18, 'goat', 30361,  0x88853D410299BCBfE5fCC9Eef93c03115E908279 ,  0x3a1293Bdb83bBbDd5Ebf4fAc96605aD2021BbC0f ),

('USDC', 6 , 'berachain', 30362, 0xAF54BE5B6eEc24d6BFACf1cce4eaF680A8239398, 0x549943e04f40284185054145c6E4e9568C1D3241),  
('WETH', 18 , 'berachain', 30362, 0x45f1A95A4D3f3836523F5c83673c797f4d4d263B, 0x2F6F07CDcf3588944Bf4C42aC74ff24bF56e7590), 

('USDC', 6, 'rootstock', 30333,  0xAF54BE5B6eEc24d6BFACf1cce4eaF680A8239398 ,  0x74c9f2b00581f1b11aa7ff05aa9f608b7389de67 ),
('USDT', 6, 'rootstock', 30333,  0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6 ,  0xaf368c91793cb22739386dfcbbb2f1a9e4bcbebf ),
('WETH', 18, 'rootstock', 30333,  0x45f1A95A4D3f3836523F5c83673c797f4d4d263B ,  0x2F6F07CDcf3588944Bf4C42aC74ff24bF56e7590 ),

('USDC', 6, 'hemi', 30329,  0x45f1A95A4D3f3836523F5c83673c797f4d4d263B ,  0xad11a8BEb98bbf61dbb1aa0F6d6F2ECD87b35afA ),
('USDT', 6, 'hemi', 30329,  0xAF54BE5B6eEc24d6BFACf1cce4eaF680A8239398 ,  0xbB0D083fb1be0A9f6157ec484b6C79E0A4e31C2e ),
('WETH', 18, 'hemi', 30329,  0x2F6F07CDcf3588944Bf4C42aC74ff24bF56e7590 ,  0xad11a8BEb98bbf61dbb1aa0F6d6F2ECD87b35afA ),

('USDC', 6, 'vana', 30330,  0x45A01E4e04F14f7A4a6702c74187c5F6222033cd ,  0xF1815bd50389c46847f0Bda824eC8da914045D14 ),
('USDT', 6, 'vana', 30330,  0xF2c0e57f48276112a596e141817D93bE472Ed6c5 ,  0x88853D410299BCBfE5fCC9Eef93c03115E908279 ),
('WETH', 18, 'vana', 30330,  0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6 ,  0x2F6F07CDcf3588944Bf4C42aC74ff24bF56e7590 ),

('USDC', 6, 'ink', 30339,  0x2F6F07CDcf3588944Bf4C42aC74ff24bF56e7590 ,  0xF1815bd50389c46847f0Bda824eC8da914045D14 ),

('USDC', 6, 'glue', 30342,  0xaf54be5b6eec24d6bfacf1cce4eaf680a8239398 ,  0xee45ed3f6c675f319bb9de62991c1e78b484e0b8 ),
('USDT', 6, 'glue', 30342,  0xaf5191b0de278c7286d6c7cc6ab6bb8a73ba2cd6 ,  0xe1ad845d93853fff44990ae0dcecd8575293681e ),
('WETH', 18, 'glue', 30342,  0x45f1a95a4d3f3836523f5c83673c797f4d4d263b ,  0x2f6f07cdcf3588944bf4c42ac74ff24bf56e7590 ),

('USDC', 6, 'fuse', 30138,  0xaf54be5b6eec24d6bfacf1cce4eaf680a8239398 ,  0xc6bc407706b7140ee8eef2f86f9504651b63e7f9 ),
('USDT', 6, 'fuse', 30138,  0xaf5191b0de278c7286d6c7cc6ab6bb8a73ba2cd6 ,  0x3695dd1d1d43b794c0b13eb8be8419eb3ac22bf7 ),
('WETH', 18, 'fuse', 30138,  0x45f1a95a4d3f3836523f5c83673c797f4d4d263b ,  0x2f6f07cdcf3588944bf4c42ac74ff24bf56e7590 ),

('USDC', 6, 'superposition', 30327,  0x8ee21165ecb7562ba716c9549c1de751282b9b33 ,  0x6c030c5cc283f791b26816f325b9c632d964f8a1 ),

('USDC', 6, 'degen', 30267,  0xaf54be5b6eec24d6bfacf1cce4eaf680a8239398 ,  0xf1815bd50389c46847f0bda824ec8da914045d14 ),
('USDT', 6, 'degen', 30267,  0xaf5191b0de278c7286d6c7cc6ab6bb8a73ba2cd6 ,  0x674843c06ff83502ddb4d37c2e09c01cda38cbc8 ),
('WETH', 18, 'degen', 30267,  0x45f1a95a4d3f3836523f5c83673c797f4d4d263b ,  0x2f6f07cdcf3588944bf4c42ac74ff24bf56e7590 ),

('USDC', 6, 'codex', 30323,  0x2f6f07cdcf3588944bf4c42ac74ff24bf56e7590 ,  0xbba60da06c2c5424f03f7434542280fcad453d10 ),

('USDC', 6, 'story', 30364,  0x2086f755a6d9254045c257ea3d382ef854849b0f ,  0xf1815bd50389c46847f0bda824ec8da914045d14 ),
('USDT', 6, 'story', 30364,  0x3a1293bdb83bbbdd5ebf4fac96605ad2021bbc0f ,  0x674843c06ff83502ddb4d37c2e09c01cda38cbc8 ),
('WETH', 18, 'story', 30364,  0xa272ffe20cffe769cdfc4b63088dcd2c82a2d8f9 ,  0xBAb93B7ad7fE8692A878B95a8e689423437cc500 ),

('USDC', 6, 'apechain', 30312,  0x2086f755a6d9254045c257ea3d382ef854849b0f ,  0xf1815bd50389c46847f0bda824ec8da914045d14 ),
('USDT', 6, 'apechain', 30312,  0xeb8d955d8ae221e5b502851ddd78e6c4498db4f6 ,  0x674843c06ff83502ddb4d37c2e09c01cda38cbc8 ),
('WETH', 18, 'apechain', 30312,  0x28e0f0eed8d6a6a96033feee8b2d7f32eb5ccc48 ,  0xf4d9235269a96aadafc9adae454a0618ebe37949 ),

('USDC', 6, 'telos', 30199,  0x2086f755a6d9254045c257ea3d382ef854849b0f ,  0xf1815bd50389c46847f0bda824ec8da914045d14 ),
('USDT', 6, 'telos', 30199,  0x3a1293bdb83bbbdd5ebf4fac96605ad2021bbc0f ,  0x674843c06ff83502ddb4d37c2e09c01cda38cbc8 ),
('WETH', 18, 'telos', 30199,  0xa272ffe20cffe769cdfc4b63088dcd2c82a2d8f9 ,  0xbab93b7ad7fe8692a878b95a8e689423437cc500 ),

('USDC', 6, 'plume', 30370,  0x9909fa99b7f7ee7f1c0cbf133f411d43083631e6 ,  0x78add880a697070c1e765ac44d65323a0dcce913 ),
('USDT', 6, 'plume', 30370,  0x2d870d17e640ed6c057afbaa0df56b8dea5cf2f6 ,  0xda6087e69c51e7d31b6dbad276a3c44703dfdcad ),
('WETH', 18, 'plume', 30370,  0x4683ce822272cd66cea73f5f1f9f5cbcaef4f066 ,  0xca59ca09e5602fae8b629dee83ffa819741f14be ),

('USDC', 6, 'xdc', 30365,  0x8E2E38711080bF8AAb9C74f434d2bae70e67ae44 ,  0xCc0587aeBDa397146cc828b445dB130a94486e74 ),
('USDT', 6, 'xdc', 30365,  0xA4272ad93AC5d2FF048DD6419c88Eb4C1002Ec6b ,  0xcdA5b77E2E2268D9E09c874c1b9A4c3F07b37555 ),
('WETH', 18, 'xdc', 30365,  0xB0d27478A40223e427697Da523c6A3DAF29AaFfB ,  0xa7348290de5cf01772479c48D50dec791c3fC212 )
),


logs as (
  SELECT
    e.block_time,
    e.block_number,
    e.contract_address AS pool_name,
    varbinary_substring(e.topic2, 13, 20) AS user,
    e.tx_hash,
    e.blockchain AS to_chain
  FROM {{ source('evms', 'logs') }} e
  JOIN assets a 
  ON e.contract_address = a.pool AND e.blockchain = a.chain
  WHERE topic0 = 0xefed6d3500546b29533b128a29e3a94d70788727f0507505ac12eaf2e578fd9c
   AND block_time > now() - interval '3' month),

user_tx_counts AS (
  SELECT
    t.blockchain,
    t."from" AS user,
    COUNT(*) AS tx_count_last_30_days
  FROM  {{ source('evms', 'transactions') }} t
  WHERE t.block_time >= CURRENT_DATE - INTERVAL '100' DAY
  GROUP BY t.blockchain, t."from"
),

eligible_users AS (
  SELECT DISTINCT q.user, q.to_chain AS blockchain
  FROM logs q
  JOIN user_tx_counts c
    ON q.user = c.user AND q.to_chain = c.blockchain
  WHERE c.tx_count_last_30_days <= 1500
),

input_tx AS (
  SELECT
    q.user,
    q.to_chain AS blockchain,
    q.tx_hash AS bridge_tx_hash,
    q.block_number AS bridge_block_number,
    q.block_time AS bridge_block_time
  FROM logs q
  JOIN eligible_users e
    ON q.user = e.user AND q.to_chain = e.blockchain
),

outgoing_transactions AS (
  SELECT
    t.blockchain,
    t."from" AS user,
    t.hash,
    t.block_number,
    t.index,
    t.block_time,
    t.data
  FROM {{ source('evms', 'transactions') }} t
  WHERE t.block_time >= CURRENT_DATE - INTERVAL '100' DAY
    AND (t.blockchain, t."from") IN (
      SELECT blockchain, user FROM eligible_users
    )
),

prev_tx AS (
  SELECT
    o.*,
    i.bridge_tx_hash,
    ROW_NUMBER() OVER (
      PARTITION BY i.bridge_tx_hash
      ORDER BY o.block_number DESC
    ) AS rn
  FROM input_tx i
  JOIN outgoing_transactions o
    ON o.user = i.user
    AND o.blockchain = i.blockchain
    AND o.block_number < i.bridge_block_number
),

next_tx AS (
  SELECT
    o.*,
    i.bridge_tx_hash,
    ROW_NUMBER() OVER (
      PARTITION BY i.bridge_tx_hash
      ORDER BY o.block_number ASC
    ) AS rn
  FROM input_tx i
  JOIN outgoing_transactions o
    ON o.user = i.user
    AND o.blockchain = i.blockchain
    AND o.block_number > i.bridge_block_number
)

SELECT 
  i.user,
  i.blockchain,

  i.bridge_tx_hash,
  i.bridge_block_number,
  i.bridge_block_time,

  -- previous tx
  p.hash AS prev_tx_hash,
  p.block_number AS prev_block_number,
  p.block_time AS prev_block_time,
  p.data AS prev_data,
  -- next tx
  n.hash AS next_tx_hash,
  n.block_number AS next_block_number,
  n.block_time AS next_block_time,
  n.data AS next_data

FROM input_tx i
LEFT JOIN prev_tx p ON p.bridge_tx_hash = i.bridge_tx_hash AND p.rn = 1
LEFT JOIN next_tx n ON n.bridge_tx_hash = i.bridge_tx_hash AND n.rn = 1
